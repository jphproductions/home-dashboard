<article id="spotify-tile" class="tile spotify-area">
    <h2>ğŸµ Spotify</h2>

    {% if not authenticated %}
    <!-- Authentication Required -->
    <div class="message info">
        <strong>Spotify Not Connected</strong><br>
        Connect your Spotify account to control playback.
    </div>
    <a href="/api/spotify/auth/login" class="button">
        ğŸ”— Authenticate Spotify
    </a>
    <p class="spotify-auth-note">
        You'll be redirected to Spotify, then automatically back to this dashboard.
    </p>

    {% else %}
    <!-- Current Track Info - Update this section independently -->
    <div id="playback-status">
        {% if track_name %}
        <div class="spotify-track-info">
            <strong>Now Playing:</strong><br>
            ğŸµ {{ track_name }}<br>
            {% if artist_name %}ğŸ‘¤ {{ artist_name }}<br>{% endif %}
            {% if device_name %}ğŸ“± {{ device_name }}{% endif %}
        </div>
        {% else %}
        <div class="spotify-track-info caption">
            Nothing currently playing
        </div>
        {% endif %}
    </div>

    <!-- Playlist Selection -->
    <div class="spotify-section">
        <strong>Select Playlist:</strong>
        <div class="spotify-playlist-grid">
            <select id="playlist-select" name="playlist">
                <option value="">Select...</option>
                {% for playlist in playlists %}
                <option value="{{ playlist.uri }}">{{ playlist.name }}</option>
                {% endfor %}
            </select>
            <button
                class="button button-secondary button-nowrap"
                hx-post="/api/spotify/play-playlist-from-form"
                hx-include="#playlist-select"
                hx-target="#playback-status"
                hx-swap="innerHTML"
                hx-indicator="#spotify-loading">
                â–¶ï¸ Play
            </button>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="spotify-loading" class="htmx-indicator">â³ Updating...</div>

    <!-- Playback Controls -->
    <div class="spotify-controls">
        <button
            class="button button-secondary"
            hx-post="/api/spotify/previous"
            hx-target="#playback-status"
            hx-swap="innerHTML"
            hx-indicator="#spotify-loading">
            â®ï¸ Previous
        </button>

        {% if is_playing %}
        <button
            class="button button-secondary"
            hx-post="/api/spotify/pause"
            hx-target="#playback-status"
            hx-swap="innerHTML"
            hx-indicator="#spotify-loading">
            â¸ï¸ Pause
        </button>
        {% else %}
        <button
            class="button button-secondary"
            hx-post="/api/spotify/play"
            hx-target="#playback-status"
            hx-swap="innerHTML"
            hx-indicator="#spotify-loading">
            â–¶ï¸ Play
        </button>
        {% endif %}

        <button
            class="button button-secondary"
            hx-post="/api/spotify/next"
            hx-target="#playback-status"
            hx-swap="innerHTML"
            hx-indicator="#spotify-loading">
            â­ï¸ Next
        </button>

        <button
            class="button button-secondary"
            disabled
            title="Coming soon">
            ğŸ”‡ Mute
        </button>
    </div>

    <!-- Wake TV & Play -->
    <button
        class="button button-full-width"
        hx-post="/api/spotify/wake-and-play"
        hx-target="#playback-status"
        hx-swap="innerHTML"
        hx-indicator="#spotify-loading">
        ğŸ“º Wake TV & Play
    </button>

    {% endif %}
</article>

<script>
    // Smart auto-refresh: reload tile when track is about to end or every 10s
    {% if is_playing and progress_ms is not none and duration_ms is not none %}
    (function() {
        const timeRemainingMs = {{ duration_ms }} - {{ progress_ms }};
        let refreshDelayMs;

        if (timeRemainingMs <= 10000) {
            // Within final 10 seconds: refresh 1s after track ends
            refreshDelayMs = timeRemainingMs + 1000;
        } else {
            // Check again in 10 seconds
            refreshDelayMs = 10000;
        }

        setTimeout(function() {
            htmx.trigger('#spotify-tile', 'refresh');
        }, refreshDelayMs);
    })();
    {% endif %}
</script>
